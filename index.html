<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能文档编辑器 - 支持数学公式</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --dark: #2b2d42;
            --light: #f8f9fa;
            --gray: #adb5bd;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            overflow: hidden;
            background-color: white;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .toolbar {
            display: flex;
            flex-direction: column;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .toolbar-section {
            display: flex;
            align-items: center;
            padding: 5px 10px; /* 减少内边距 */
            border-bottom: 1px solid #e0e0e0;
        }
        
        .toolbar-section:last-child {
            border-bottom: none;
        }
        
        .toolbar-label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.8rem; /* 减小字体大小 */
            margin-right: 10px; /* 减少右边距 */
            min-width: 50px; /* 减小最小宽度 */
        }
        
        button {
            background-color: var(--white);
            color: var(--dark);
            border: 1px solid #e0e0e0;
            padding: 4px 8px; /* 减少内边距 */
            border-radius: 4px; /* 减小圆角 */
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px; /* 减少间距 */
            min-height: 28px; /* 减小最小高度 */
            font-size: 12px; /* 减小字体大小 */
            margin-right: 6px; /* 减少右边距 */
        }
        
        button:hover {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        select, input[type="color"] {
            padding: 4px 6px; /* 减少内边距 */
            border-radius: 4px; /* 减小圆角 */
            border: 1px solid #e0e0e0;
            background: var(--white);
            min-height: 28px; /* 减小最小高度 */
            font-size: 12px; /* 减小字体大小 */
            margin-right: 6px; /* 减少右边距 */
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
            background-size: 12px; /* 减小图标大小 */
            padding-right: 24px; /* 减小右边距 */
        }
        
        .editor-preview-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .editor-section, .preview-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
        }
        
        .preview-section {
            border-right: none;
        }
        
        .section-header {
            background-color: #ecf0f1;
            padding: 8px 15px; /* 减少内边距 */
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem; /* 减小字体大小 */
        }
        
        .section-info {
            font-size: 0.7rem; /* 减小字体大小 */
            color: #7f8c8d;
            font-weight: normal;
        }
        
        .editor {
            flex: 1;
            padding: 15px; /* 减少内边距 */
            overflow-y: auto;
            border: none;
            outline: none;
            font-size: 14px; /* 减小字体大小 */
            line-height: 1.5;
            resize: none;
            min-height: 100%;
            background-color: white;
        }
        
        .preview {
            flex: 1;
            padding: 15px; /* 减少内边距 */
            overflow-y: auto;
            background-color: #f9f9f9;
            border-left: 1px solid #e0e0e0;
        }
        
        .status-bar {
            background-color: #ecf0f1;
            padding: 6px 15px; /* 减少内边距 */
            display: flex;
            justify-content: space-between;
            font-size: 12px; /* 减小字体大小 */
            color: #7f8c8d;
        }
        
        .word-count {
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px; /* 减少内边距 */
            border-radius: 12px; /* 减小圆角 */
            width: 90%;
            max-width: 450px; /* 减小最大宽度 */
            box-shadow: var(--shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px; /* 减少下边距 */
            padding-bottom: 8px; /* 减少内边距 */
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 1.1rem; /* 减小字体大小 */
            font-weight: bold;
            color: var(--primary);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.3rem; /* 减小字体大小 */
            cursor: pointer;
            color: var(--gray);
        }
        
        .modal-body {
            margin-bottom: 15px; /* 减少下边距 */
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px; /* 减少间距 */
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 15px; /* 减少内边距 */
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.9rem; /* 减小字体大小 */
        }
        
        .preview-content {
            background-color: white;
            padding: 15px; /* 减少内边距 */
            min-height: 100%;
            box-shadow: 0 0 8px rgba(0,0,0,0.05); /* 减小阴影 */
            line-height: 1.6;
            font-size: 14px; /* 减小字体大小 */
        }
        
        .math-formula {
            margin: 8px 0; /* 减少边距 */
            padding: 8px; /* 减少内边距 */
            background-color: #f8f9fa;
            border-radius: 3px; /* 减小圆角 */
            border-left: 3px solid var(--primary); /* 减小边框宽度 */
        }
        
        .formula-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 4px; /* 减少间距 */
            margin-top: 8px; /* 减少上边距 */
        }
        
        .formula-btn {
            background-color: #9b59b6;
            color: white;
            font-size: 11px; /* 减小字体大小 */
            padding: 4px 8px; /* 减少内边距 */
        }
        
        .formula-btn:hover {
            background-color: #8e44ad;
        }
        
        .katex { 
            font-size: 1em; /* 减小字体大小 */
            padding: 1px 3px; /* 减少内边距 */
        }
        .katex-display {
            margin: 1em 0; /* 减少边距 */
            text-align: center;
            overflow-x: auto;
            overflow-y: hidden;
        }
        
        .style-btn {
            background-color: #e9ecef;
            color: var(--dark);
        }
        
        .style-btn:hover {
            background-color: #dee2e6;
        }
        
        /* 下拉菜单样式 */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-btn {
            background-color: var(--white);
            color: var(--dark);
            border: 1px solid #e0e0e0;
            padding: 4px 8px; /* 减少内边距 */
            border-radius: 4px; /* 减小圆角 */
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px; /* 减少间距 */
            min-height: 28px; /* 减小最小高度 */
            font-size: 12px; /* 减小字体大小 */
            margin-right: 6px; /* 减少右边距 */
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 140px; /* 减小最小宽度 */
            box-shadow: 0px 6px 12px 0px rgba(0,0,0,0.2); /* 减小阴影 */
            z-index: 1;
            border-radius: 4px; /* 减小圆角 */
            overflow: hidden;
            margin-top: 4px; /* 减少上边距 */
        }
        
        .dropdown-content button {
            width: 100%;
            margin: 0;
            border: none;
            border-radius: 0;
            text-align: left;
            justify-content: flex-start;
        }
        
        .dropdown-content button:hover {
            background-color: var(--primary);
            color: white;
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        /* 菜单和样式在同一行 */
        .menu-styles-section {
            display: flex;
            align-items: center;
            padding: 5px 10px; /* 减少内边距 */
            border-bottom: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .menu-styles-section .toolbar-label {
            margin-right: 8px; /* 减少右边距 */
        }
        
        .menu-styles-section .dropdown {
            margin-right: 12px; /* 减少右边距 */
        }
        
        /* 字体与格式在同一行，但分为两部分 */
        .font-format-section {
            display: flex;
            align-items: center;
            padding: 5px 10px; /* 减少内边距 */
            border-bottom: 1px solid #e0e0e0;
        }
        
        .font-part, .format-part {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .font-part {
            border-right: 2px solid #e0e0e0;
            padding-right: 12px; /* 减少内边距 */
            margin-right: 12px; /* 减少右边距 */
        }
        
        .format-part {
            padding-left: 4px; /* 减少内边距 */
        }
        
        /* 数学公式标签页样式 */
        .formula-tabs {
            display: flex;
            margin-bottom: 8px; /* 减少下边距 */
            border-bottom: 1px solid #e0e0e0;
        }
        
        .formula-tab {
            padding: 6px 12px; /* 减少内边距 */
            background: #f5f5f5;
            border: none;
            border-radius: 4px 4px 0 0; /* 减小圆角 */
            margin-right: 4px; /* 减少右边距 */
            cursor: pointer;
            font-size: 12px; /* 减小字体大小 */
            transition: all 0.3s;
        }
        
        .formula-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .formula-tab-content {
            display: none;
        }
        
        .formula-tab-content.active {
            display: flex;
            flex-wrap: wrap;
            gap: 4px; /* 减少间距 */
        }
        
        /* 图标大小调整 */
        .fa, .fas, .far, .fal, .fad, .fab {
            font-size: 12px; /* 减小图标大小 */
        }
        
        @media (max-width: 768px) {
            .editor-preview-container {
                flex-direction: column;
            }
            
            .editor-section, .preview-section {
                flex: 1;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .toolbar-section {
                flex-wrap: wrap;
            }
            
            .toolbar-label {
                width: 100%;
                margin-bottom: 4px; /* 减少下边距 */
            }
            
            button {
                padding: 4px 6px; /* 减少内边距 */
                font-size: 11px; /* 减小字体大小 */
            }
            
            .editor, .preview {
                padding: 12px; /* 减少内边距 */
                font-size: 13px; /* 减小字体大小 */
            }
            
            .formula-buttons {
                justify-content: center;
            }
            
            .menu-styles-section {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .menu-styles-section .dropdown {
                margin-bottom: 6px; /* 减少下边距 */
            }
            
            .font-format-section {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .font-part, .format-part {
                width: 100%;
                border-right: none;
                padding-right: 0;
                margin-right: 0;
                margin-bottom: 8px; /* 减少下边距 */
            }
            
            .format-part {
                padding-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo"><i class="fas fa-edit"></i> 智能文档编辑器</div>
        </header>
        
        <div class="toolbar">
            <!-- 菜单栏和样式栏在同一行 -->
            <div class="menu-styles-section">
                <span class="toolbar-label">菜单:</span>
                <div class="dropdown">
                    <button class="dropdown-btn"><i class="fas fa-bars"></i> 文件 <i class="fas fa-chevron-down"></i></button>
                    <div class="dropdown-content">
                        <button id="newBtn"><i class="fas fa-file"></i> 新建</button>
                        <button id="openBtn"><i class="fas fa-folder-open"></i> 打开</button>
                        <button id="saveBtn"><i class="fas fa-save"></i> 保存</button>
                        <button id="exportBtn"><i class="fas fa-file-export"></i> 导出</button>
                    </div>
                </div>
                
                <span class="toolbar-label">样式:</span>
                <div class="dropdown">
                    <button class="dropdown-btn"><i class="fas fa-paint-brush"></i> 样式 <i class="fas fa-chevron-down"></i></button>
                    <div class="dropdown-content">
                        <button id="questionBtn" class="style-btn"><i class="fas fa-question-circle"></i> 题目</button>
                        <button id="answerBtn" class="style-btn"><i class="fas fa-check-circle"></i> 答案</button>
                        <button id="analysisBtn" class="style-btn"><i class="fas fa-lightbulb"></i> 解析</button>
                        <button id="tagBtn" class="style-btn"><i class="fas fa-tag"></i> 标签</button>
                    </div>
                </div>
            </div>
            
            <!-- 字体与格式栏在同一行但分为两部分 -->
            <div class="font-format-section">
                <div class="font-part">
                    <span class="toolbar-label">字体:</span>
                    <select id="fontFamily">
                        <option value="Arial" selected>Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Georgia">Georgia</option>
                        <option value="微软雅黑">微软雅黑</option>
                        <option value="宋体">宋体</option>
                    </select>
                    
                    <select id="fontSize">
                        <option value="8px">8px</option>
                        <option value="10px">10px</option>
                        <option value="12px">12px</option>
                        <option value="14px">14px</option>
                        <option value="16px" selected>16px</option>
                        <option value="18px">18px</option>
                        <option value="20px">20px</option>
                        <option value="22px">22px</option>
                        <option value="24px">24px</option>
                        <option value="26px">26px</option>
                        <option value="28px">28px</option>
                        <option value="30px">30px</option>
                        <option value="32px">32px</option>
                        <option value="36px">36px</option>
                        <option value="40px">40px</option>
                        <option value="48px">48px</option>
                        <option value="56px">56px</option>
                        <option value="64px">64px</option>
                        <option value="72px">72px</option>
                    </select>
                    
                    <input type="color" id="fontColor" title="字体颜色">
                    
                    <button id="boldBtn" title="粗体"><i class="fas fa-bold"></i></button>
                    <button id="italicBtn" title="斜体"><i class="fas fa-italic"></i></button>
                    <button id="underlineBtn" title="下划线"><i class="fas fa-underline"></i></button>
                </div>
                
                <div class="format-part">
                    <span class="toolbar-label">格式:</span>
                    <select id="headingLevel">
                        <option value="">正文</option>
                        <option value="h1">标题1</option>
                        <option value="h2">标题2</option>
                        <option value="h3">标题3</option>
                    </select>
                    
                    <button id="alignLeftBtn" title="左对齐"><i class="fas fa-align-left"></i></button>
                    <button id="alignCenterBtn" title="居中对齐"><i class="fas fa-align-center"></i></button>
                    <button id="alignRightBtn" title="右对齐"><i class="fas fa-align-right"></i></button>
                    
                    <select id="letterSpacing">
                        <option value="normal">标准字距</option>
                        <option value="1px">紧凑</option>
                        <option value="2px">宽松</option>
                        <option value="3px">很宽松</option>
                    </select>
                    
                    <select id="lineHeight">
                        <option value="1">单倍行距</option>
                        <option value="1.15" selected>1.15倍行距</option>
                        <option value="1.5">1.5倍行距</option>
                        <option value="2">双倍行距</option>
                    </select>
                </div>
            </div>
            
            <!-- 数学公式栏 - 分页标签形式 -->
            <div class="toolbar-section">
                <span class="toolbar-label">公式:</span>
                <button id="insertFormulaBtn"><i class="fas fa-square-root-alt"></i> 插入公式</button>
                
                <div class="formula-tabs-container">
                    <div class="formula-tabs">
                        <button class="formula-tab active" data-tab="basic">基础</button>
                        <button class="formula-tab" data-tab="operators">运算符</button>
                        <button class="formula-tab" data-tab="greek">希腊字母</button>
                        <button class="formula-tab" data-tab="advanced">高级</button>
                    </div>
                    
                    <div class="formula-tab-content active" id="basic-tab">
                        <button class="formula-btn" data-formula="\\frac{a}{b}">分数</button>
                        <button class="formula-btn" data-formula="\\sqrt{x}">平方根</button>
                        <button class="formula-btn" data-formula="x^{2}">上标</button>
                        <button class="formula-btn" data-formula="x_{2}">下标</button>
                    </div>
                    
                    <div class="formula-tab-content" id="operators-tab">
                        <button class="formula-btn" data-formula="\\pm \\times \\div">运算符</button>
                        <button class="formula-btn" data-formula="\\leq \\geq \\neq">关系符</button>
                        <button class="formula-btn" data-formula="\\sum_{i=1}^{n}">求和</button>
                        <button class="formula-btn" data-formula="\\int_{a}^{b}">积分</button>
                    </div>
                    
                    <div class="formula-tab-content" id="greek-tab">
                        <button class="formula-btn" data-formula="\\alpha \\beta \\gamma">希腊字母</button>
                        <button class="formula-btn" data-formula="\\delta \\epsilon \\zeta">更多字母</button>
                        <button class="formula-btn" data-formula="\\theta \\lambda \\mu">数学字母</button>
                        <button class="formula-btn" data-formula="\\pi \\sigma \\omega">常用符号</button>
                    </div>
                    
                    <div class="formula-tab-content" id="advanced-tab">
                        <button class="formula-btn" data-formula="\\infty \\partial \\nabla">特殊符号</button>
                        <button class="formula-btn" data-formula="\\binom{n}{k}">组合数</button>
                        <button class="formula-btn" data-formula="\\lim_{x \\to a}">极限</button>
                        <button class="formula-btn" data-formula="\\vec{v} \\cdot \\vec{w}">向量</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="editor-preview-container">
            <div class="editor-section">
                <div class="section-header">
                    <span><i class="fas fa-edit"></i> 编辑区域</span>
                    <span class="section-info">使用$...$表示行内公式，$$...$$表示独立公式</span>
                </div>
                <div id="editor" class="editor" contenteditable="true">
                    <h1>欢迎使用智能文档编辑器</h1>
                    <p>这是一个功能丰富的在线文档编辑器，支持打开Word文档(.docx)、导出Word和PDF文档，并实时预览数学公式。</p>
                    
                    <h2>数学公式示例</h2>
                    <p>行内公式示例：当 $a \ne 0$ 时，一元二次方程 $ax^2 + bx + c = 0$ 的解为：</p>
                    
                    <div class="math-formula">
                        <p>独立公式示例：</p>
                        <p>$$x = {-b \pm \sqrt{b^2-4ac} \over 2a}$$</p>
                    </div>
                    
                    <p>更多示例：</p>
                    <ul>
                        <li>勾股定理：$a^2 + b^2 = c^2$</li>
                        <li>欧拉公式：$e^{i\pi} + 1 = 0$</li>
                        <li>积分公式：$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$</li>
                    </ul>
                    
                    <p>您可以直接在此编辑文本，使用上方工具栏格式化内容，并使用公式按钮快速插入常用数学符号。</p>
                    <p>点击"打开文档"按钮可以打开本地Word文件，编辑后可以使用"导出"按钮保存您的工作。</p>
                    <p>右侧是实时预览区域，可以查看文档的最终效果，包括渲染后的数学公式。</p>
                    <p>祝您使用愉快！</p>
                </div>
            </div>
            
            <div class="preview-section">
                <div class="section-header">
                    <span><i class="fas fa-eye"></i> 预览区域</span>
                    <span class="section-info">数学公式将在这里实时渲染</span>
                </div>
                <div class="preview">
                    <div class="preview-content" id="previewContent">
                        <!-- 预览内容将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="word-count">字数: <span id="wordCount">0</span></div>
            <div>智能文档编辑器 v2.0 - 支持数学公式</div>
        </div>
    </div>
    
    <!-- 文件打开模态框 -->
    <div id="openModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-folder-open"></i> 打开文档</div>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p>选择要打开的Word文档(.docx):</p>
                <input type="file" id="fileInput" class="file-input" accept=".docx,.doc" style="display: none;">
                <button id="selectFileBtn" style="margin-top: 8px; width: 100%;">选择文件</button>
                <div id="fileName" style="margin-top: 8px; font-style: italic; font-size: 0.9rem;"></div>
                <div class="loading" id="fileLoading">正在处理文档，请稍候...</div>
            </div>
            <div class="modal-footer">
                <button id="cancelOpenBtn" class="btn-secondary">取消</button>
                <button id="confirmOpenBtn" class="btn-primary">打开</button>
            </div>
        </div>
    </div>
    
    <!-- 导出选项模态框 -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-file-export"></i> 导出文档</div>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p>请输入文件名:</p>
                <input type="text" id="fileNameInput" placeholder="文档名称" style="width: 100%; padding: 8px; margin-top: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.9rem;">
                <div id="exportType" style="margin-top: 12px;">
                    <p>导出格式:</p>
                    <input type="radio" id="exportWord" name="exportType" value="word" checked>
                    <label for="exportWord">Word文档 (.docx)</label><br>
                    <input type="radio" id="exportPdf" name="exportType" value="pdf">
                    <label for="exportPdf">PDF文档 (.pdf)</label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelExportBtn" class="btn-secondary">取消</button>
                <button id="confirmExportBtn" class="btn-primary">导出</button>
            </div>
        </div>
    </div>
    
    <!-- 公式帮助模态框 -->
    <div id="formulaHelpModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-square-root-alt"></i> 数学公式帮助</div>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p>在编辑区域使用以下语法编写数学公式：</p>
                <ul style="margin: 8px 0 8px 20px; font-size: 0.9rem;">
                    <li>行内公式：使用单个美元符号，例如：$E = mc^2$</li>
                    <li>独立公式：使用双美元符号，例如：$$E = mc^2$$</li>
                </ul>
                
                <div class="formula-buttons">
                    <button class="formula-btn" data-formula="\\frac{a}{b}">分数</button>
                    <button class="formula-btn" data-formula="\\sqrt{x}">平方根</button>
                    <button class="formula-btn" data-formula="x^{2}">上标</button>
                    <button class="formula-btn" data-formula="x_{2}">下标</button>
                    <button class="formula-btn" data-formula="\\sum_{i=1}^{n}">求和</button>
                    <button class="formula-btn" data-formula="\\int_{a}^{b}">积分</button>
                    <button class="formula-btn" data-formula="\\alpha \\beta \\gamma">希腊字母</button>
                    <button class="formula-btn" data-formula="\\pm \\times \\div">运算符</button>
                    <button class="formula-btn" data-formula="\\leq \\geq \\neq">关系符</button>
                    <button class="formula-btn" data-formula="\\infty \\partial \\nabla">特殊符号</button>
                </div>
                
                <div style="margin-top: 15px;">
                    <p>常用公式示例：</p>
                    <div class="math-formula">
                        <p>二次方程求根公式：$$x = {-b \pm \sqrt{b^2-4ac} \over 2a}$$</p>
                        <p>勾股定理：$$a^2 + b^2 = c^2$$</p>
                        <p>欧拉公式：$$e^{i\pi} + 1 = 0$$</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeFormulaHelpBtn" class="btn-primary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 引入必要的JavaScript库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/mammoth@1.4.17/mammoth.browser.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // 获取DOM元素
        const editor = document.getElementById('editor');
        const previewContent = document.getElementById('previewContent');
        const newBtn = document.getElementById('newBtn');
        const openBtn = document.getElementById('openBtn');
        const exportBtn = document.getElementById('exportBtn');
        const saveBtn = document.getElementById('saveBtn');
        const wordCount = document.getElementById('wordCount');
        const insertFormulaBtn = document.getElementById('insertFormulaBtn');
        
        // 工具栏按钮
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const underlineBtn = document.getElementById('underlineBtn');
        const fontSize = document.getElementById('fontSize');
        const fontFamily = document.getElementById('fontFamily');
        const fontColor = document.getElementById('fontColor');
        const headingLevel = document.getElementById('headingLevel');
        const alignLeftBtn = document.getElementById('alignLeftBtn');
        const alignCenterBtn = document.getElementById('alignCenterBtn');
        const alignRightBtn = document.getElementById('alignRightBtn');
        const lineHeight = document.getElementById('lineHeight');
        const letterSpacing = document.getElementById('letterSpacing');
        
        // 样式按钮
        const questionBtn = document.getElementById('questionBtn');
        const answerBtn = document.getElementById('answerBtn');
        const analysisBtn = document.getElementById('analysisBtn');
        const tagBtn = document.getElementById('tagBtn');
        
        // 模态框相关
        const openModal = document.getElementById('openModal');
        const exportModal = document.getElementById('exportModal');
        const formulaHelpModal = document.getElementById('formulaHelpModal');
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const fileName = document.getElementById('fileName');
        const fileLoading = document.getElementById('fileLoading');
        const cancelOpenBtn = document.getElementById('cancelOpenBtn');
        const confirmOpenBtn = document.getElementById('confirmOpenBtn');
        const cancelExportBtn = document.getElementById('cancelExportBtn');
        const confirmExportBtn = document.getElementById('confirmExportBtn');
        const closeFormulaHelpBtn = document.getElementById('closeFormulaHelpBtn');
        const fileNameInput = document.getElementById('fileNameInput');
        const closeBtns = document.querySelectorAll('.close-btn');
        const formulaBtns = document.querySelectorAll('.formula-btn');
        
        // 数学公式标签页
        const formulaTabs = document.querySelectorAll('.formula-tab');
        const formulaTabContents = document.querySelectorAll('.formula-tab-content');
        
        // 数学公式渲染配置
        const renderMath = () => {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(previewContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false,
                    output: 'html'
                });
            }
        };
        
        // 初始化
        updateWordCount();
        updatePreview();
        
        // 事件监听器
        editor.addEventListener('input', () => {
            updateWordCount();
            updatePreview();
        });
        
        editor.addEventListener('paste', (e) => {
            // 处理粘贴事件，去除格式
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text/plain');
            document.execCommand('insertText', false, text);
            updateWordCount();
            updatePreview();
        });
        
        // 新建文档功能
        newBtn.addEventListener('click', () => {
            if (confirm('确定要新建文档吗？未保存的内容将会丢失。')) {
                editor.innerHTML = '<h1>新文档</h1><p>开始编写您的内容...</p>';
                updateWordCount();
                updatePreview();
            }
        });
        
        // 打开文档功能
        openBtn.addEventListener('click', () => {
            openModal.style.display = 'flex';
        });
        
        selectFileBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileName.textContent = `已选择: ${e.target.files[0].name}`;
            }
        });
        
        confirmOpenBtn.addEventListener('click', () => {
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                
                // 检查文件类型
                if (!file.name.toLowerCase().endsWith('.docx') && !file.name.toLowerCase().endsWith('.doc')) {
                    alert('请选择Word文档(.docx或.doc)');
                    return;
                }
                
                fileLoading.style.display = 'block';
                
                // 使用Mammoth.js将Word文档转换为HTML
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    
                    mammoth.convertToHtml({arrayBuffer: arrayBuffer})
                        .then(function(result) {
                            editor.innerHTML = result.value;
                            updateWordCount();
                            updatePreview();
                            fileLoading.style.display = 'none';
                            openModal.style.display = 'none';
                            fileName.textContent = '';
                            fileInput.value = '';
                        })
                        .catch(function(error) {
                            console.error(error);
                            alert('文档转换失败，请确保选择的是有效的Word文档');
                            fileLoading.style.display = 'none';
                        });
                };
                
                reader.readAsArrayBuffer(file);
            } else {
                alert('请先选择一个文件');
            }
        });
        
        // 导出功能
        exportBtn.addEventListener('click', () => {
            document.getElementById('exportWord').checked = true;
            fileNameInput.value = '文档_' + new Date().toISOString().slice(0, 10);
            exportModal.style.display = 'flex';
        });
        
        confirmExportBtn.addEventListener('click', () => {
            const fileName = fileNameInput.value || '未命名文档';
            const exportType = document.querySelector('input[name="exportType"]:checked').value;
            
            if (exportType === 'word') {
                exportToWord(fileName);
            } else {
                exportToPdf(fileName);
            }
            
            exportModal.style.display = 'none';
        });
        
        // 保存功能
        saveBtn.addEventListener('click', () => {
            alert('文档已保存（模拟功能）');
        });
        
        // 公式功能
        insertFormulaBtn.addEventListener('click', () => {
            formulaHelpModal.style.display = 'flex';
        });
        
        // 公式按钮点击事件
        formulaBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const formula = btn.getAttribute('data-formula');
                insertFormulaAtCursor(`$${formula}$`);
            });
        });
        
        // 公式标签页切换
        formulaTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // 移除所有标签的active类
                formulaTabs.forEach(t => t.classList.remove('active'));
                // 添加当前标签的active类
                tab.classList.add('active');
                
                // 隐藏所有标签内容
                formulaTabContents.forEach(content => content.classList.remove('active'));
                // 显示当前标签内容
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        closeFormulaHelpBtn.addEventListener('click', () => {
            formulaHelpModal.style.display = 'none';
        });
        
        // 关闭模态框
        cancelOpenBtn.addEventListener('click', () => {
            openModal.style.display = 'none';
            fileName.textContent = '';
            fileInput.value = '';
        });
        
        cancelExportBtn.addEventListener('click', () => {
            exportModal.style.display = 'none';
        });
        
        closeBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.modal').style.display = 'none';
                fileName.textContent = '';
                fileInput.value = '';
            });
        });
        
        // 点击模态框外部关闭
        window.addEventListener('click', (e) => {
            if (e.target === openModal) {
                openModal.style.display = 'none';
                fileName.textContent = '';
                fileInput.value = '';
            }
            if (e.target === exportModal) {
                exportModal.style.display = 'none';
            }
            if (e.target === formulaHelpModal) {
                formulaHelpModal.style.display = 'none';
            }
        });
        
        // 文本格式化功能 - 只影响选中的文本
        boldBtn.addEventListener('click', () => {
            document.execCommand('bold', false, null);
            updatePreview();
        });
        
        italicBtn.addEventListener('click', () => {
            document.execCommand('italic', false, null);
            updatePreview();
        });
        
        underlineBtn.addEventListener('click', () => {
            document.execCommand('underline', false, null);
            updatePreview();
        });
        
        fontSize.addEventListener('change', () => {
            // 使用CSS样式而不是fontSize命令，以便精确控制字体大小
            document.execCommand('styleWithCSS', false, true);
            document.execCommand('fontSize', false, '7'); // 使用7作为默认值
            document.execCommand('styleWithCSS', false, false);
            
            // 获取选中的文本并应用字体大小
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                
                if (selectedText) {
                    // 创建一个span元素来包装选中的文本
                    const span = document.createElement('span');
                    span.style.fontSize = fontSize.value;
                    range.surroundContents(span);
                } else {
                    // 如果没有选中文本，设置插入点的样式
                    document.execCommand('insertHTML', false, `<span style="font-size: ${fontSize.value}">${fontSize.value}</span>`);
                }
            }
            
            updatePreview();
        });
        
        fontFamily.addEventListener('change', () => {
            document.execCommand('fontName', false, fontFamily.value);
            updatePreview();
        });
        
        fontColor.addEventListener('input', () => {
            document.execCommand('foreColor', false, fontColor.value);
            updatePreview();
        });
        
        headingLevel.addEventListener('change', () => {
            const level = headingLevel.value;
            if (!level) return;

            const selection = window.getSelection();
            if (!selection.rangeCount) {
                alert('请先选择要应用标题的文本');
                return;
            }

            const range = selection.getRangeAt(0);
            const selectedText = range.toString().trim();
            
            if (!selectedText) {
                alert('请先选择要应用标题的文本');
                return;
            }

            const content = range.extractContents();
            const heading = document.createElement(level);
            heading.appendChild(content);
            range.insertNode(heading);
            
            // 重置选择
            headingLevel.value = '';
            
            updatePreview();
        });
        
        alignLeftBtn.addEventListener('click', () => {
            document.execCommand('justifyLeft', false, null);
            updatePreview();
        });
        
        alignCenterBtn.addEventListener('click', () => {
            document.execCommand('justifyCenter', false, null);
            updatePreview();
        });
        
        alignRightBtn.addEventListener('click', () => {
            document.execCommand('justifyRight', false, null);
            updatePreview();
        });
        
        lineHeight.addEventListener('change', () => {
            // 应用行高到选中文本
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                
                if (selectedText) {
                    const span = document.createElement('span');
                    span.style.lineHeight = lineHeight.value;
                    range.surroundContents(span);
                }
            }
            updatePreview();
        });
        
        letterSpacing.addEventListener('change', () => {
            // 应用字距到选中文本
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                
                if (selectedText) {
                    const span = document.createElement('span');
                    span.style.letterSpacing = letterSpacing.value;
                    range.surroundContents(span);
                }
            }
            updatePreview();
        });
        
        // 样式按钮功能（暂时只有提示）
        questionBtn.addEventListener('click', () => {
            alert('题目样式功能（待实现）');
        });
        
        answerBtn.addEventListener('click', () => {
            alert('答案样式功能（待实现）');
        });
        
        analysisBtn.addEventListener('click', () => {
            alert('解析样式功能（待实现）');
        });
        
        tagBtn.addEventListener('click', () => {
            alert('标签功能（待实现）');
        });
        
        // 更新字数统计
        function updateWordCount() {
            const text = editor.innerText || editor.textContent;
            const count = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            wordCount.textContent = count;
        }
        
        // 更新预览区域
        function updatePreview() {
            previewContent.innerHTML = editor.innerHTML;
            
            // 使用KaTeX重新渲染数学公式
            renderMath();
        }
        
        // 在光标位置插入公式
        function insertFormulaAtCursor(formula) {
            const sel = window.getSelection();
            if (sel.rangeCount) {
                const range = sel.getRangeAt(0);
                range.deleteContents();
                const textNode = document.createTextNode(formula);
                range.insertNode(textNode);
                range.setStartAfter(textNode);
                range.setEndAfter(textNode);
                sel.removeAllRanges();
                sel.addRange(range);
            }
            updatePreview();
        }
        
        // 导出为Word文档
        function exportToWord(fileName) {
            const content = editor.innerHTML;
            
            if (!content.trim()) {
                alert('文档内容为空，无法导出');
                return;
            }

            const htmlContent = `
                <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body { 
                                font-family: ${fontFamily.value};
                                font-size: ${fontSize.value};
                                line-height: ${lineHeight.value};
                                letter-spacing: ${letterSpacing.value};
                            }
                            h1 { color: #4361ee; }
                            h2 { color: #4361ee; }
                            h3 { color: #4361ee; }
                        </style>
                    </head>
                    <body>
                        ${content}
                    </body>
                </html>
            `;

            try {
                const converted = htmlDocx.asBlob(htmlContent);
                saveAs(converted, `${fileName}.docx`);
                alert(`Word文档导出成功: ${fileName}.docx`);
            } catch (error) {
                console.error('Word导出失败:', error);
                alert('Word导出失败，请重试');
            }
        }
        
        // 导出为PDF文档
        function exportToPdf(fileName) {
            const { jsPDF } = window.jspdf;
            
            // 使用html2canvas将预览内容转换为图片
            html2canvas(previewContent, {
                scale: 2, // 提高分辨率
                useCORS: true,
                logging: false,
                backgroundColor: '#FFFFFF'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; // A4宽度(毫米)
                const pageHeight = 295; // A4高度(毫米)
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // 如果内容超过一页，添加新页
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save(`${fileName}.pdf`);
                alert(`PDF文档导出成功: ${fileName}.pdf`);
            }).catch(error => {
                console.error('PDF导出失败:', error);
                alert('PDF导出失败，请重试');
            });
        }
    </script>
</body>
</html>